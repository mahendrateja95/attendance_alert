<!DOCTYPE html>
<html>
<head>
    <title>Attendance Recognition System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .video-container {
            position: relative;
            display: inline-block;
            margin: 20px 0;
        }
        .control-panel {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        .attendance-button {
            font-size: 1.2em;
            padding: 15px 30px;
            margin: 10px;
        }
        .status-message {
            margin: 15px 0;
            padding: 10px;
            border-radius: 5px;
        }
        .instructions {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }
    </style>
</head>
<body class="bg-light">
    <div class="container text-center py-4">
        <h1 class="mb-4">ğŸ¯ Attendance Recognition System</h1>
        
        <div class="instructions">
            <h5>ğŸ“‹ Instructions:</h5>
            <ul class="list-unstyled">
                <li>â€¢ <strong>Green boxes</strong> = Recognized users</li>
                <li>â€¢ <strong>Red boxes</strong> = Unknown persons</li>
                <li>â€¢ Names will appear above recognized faces</li>
                <li>â€¢ Click "Mark Attendance" to record attendance for recognized faces</li>
            </ul>
        </div>
        
        <div class="video-container">
            <img src="{{ url_for('recognize_feed') }}" width="800" height="600" class="border rounded shadow">
        </div>
        
        <div class="control-panel">
            <h5>ğŸ® Controls</h5>
            <button id="markAttendanceBtn" class="btn btn-success attendance-button" onclick="markAttendance()">
                ğŸ“ Mark Attendance
            </button>
            <button class="btn btn-secondary attendance-button" onclick="refreshCamera()">
                ğŸ”„ Refresh Camera
            </button>
            <a href="{{ url_for('index') }}" class="btn btn-primary attendance-button">
                ğŸ  Home
            </a>
        </div>
        
        <div id="statusMessage" class="status-message d-none"></div>
        
        <div class="mt-4">
            <h6>ğŸ“Š Today's Attendance Summary</h6>
            <div id="attendanceSummary" class="mt-3">
                <p class="text-muted">No attendance marked yet today.</p>
            </div>
        </div>
    </div>

    <script>
        let attendanceData = [];
        
        function markAttendance() {
            const btn = document.getElementById('markAttendanceBtn');
            const originalText = btn.innerHTML;
            
            // Disable button and show loading
            btn.innerHTML = 'â³ Marking...';
            btn.disabled = true;
            
            fetch('/mark_attendance')
                .then(response => response.json())
                .then(data => {
                    showStatusMessage(data.message, 'success');
                    updateAttendanceSummary();
                })
                .catch(error => {
                    console.error('Error marking attendance:', error);
                    showStatusMessage('Error marking attendance. Please try again.', 'error');
                })
                .finally(() => {
                    // Re-enable button
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                });
        }
        
        function showStatusMessage(message, type) {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.className = `status-message alert ${type === 'success' ? 'alert-success' : 'alert-danger'}`;
            statusDiv.textContent = message;
            statusDiv.classList.remove('d-none');
            
            // Hide after 3 seconds
            setTimeout(() => {
                statusDiv.classList.add('d-none');
            }, 3000);
        }
        
        function refreshCamera() {
            const img = document.querySelector('.video-container img');
            const src = img.src;
            img.src = '';
            setTimeout(() => {
                img.src = src + '?t=' + new Date().getTime();
            }, 100);
        }
        
        function updateAttendanceSummary() {
            const now = new Date();
            const timeString = now.toLocaleTimeString();
            const summaryDiv = document.getElementById('attendanceSummary');
            
            // Add to attendance data
            attendanceData.push({
                time: timeString,
                action: 'Attendance Marked'
            });
            
            // Update display
            let summaryHTML = '<div class="row">';
            attendanceData.slice(-5).reverse().forEach(entry => {
                summaryHTML += `
                    <div class="col-md-6 mb-2">
                        <div class="card card-body">
                            <small class="text-muted">${entry.time}</small>
                            <span>${entry.action}</span>
                        </div>
                    </div>
                `;
            });
            summaryHTML += '</div>';
            
            summaryDiv.innerHTML = summaryHTML;
        }
        
        // Keyboard shortcuts
        document.addEventListener('keydown', function(event) {
            if (event.key === 'm' || event.key === 'M') {
                markAttendance();
            } else if (event.key === 'r' || event.key === 'R') {
                refreshCamera();
            }
        });
        
        // Show keyboard shortcuts info
        setTimeout(() => {
            showStatusMessage('ğŸ’¡ Tip: Press "M" to mark attendance, "R" to refresh camera', 'success');
        }, 2000);
    </script>
</body>
</html>
