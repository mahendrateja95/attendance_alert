<!DOCTYPE html>
<html>
<head>
    <title>Camera - {{ mode|capitalize }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .progress-container {
            margin: 20px 0;
        }
        .status-text {
            font-size: 1.2em;
            font-weight: bold;
            margin: 10px 0;
        }
        .video-container {
            position: relative;
            display: inline-block;
        }
    </style>
</head>
<body class="text-center p-5 bg-light">
    <h2>{{ "Capturing face data" if mode=="capture" else "Verifying identity" }} for <b>{{ username }}</b></h2>
    
    {% if mode == "capture" %}
    <div class="progress-container">
        <div id="progress-text" class="status-text text-primary">Preparing to capture images...</div>
        <div class="progress" style="height: 25px;">
            <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" 
                 role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="300">
                0/300
            </div>
        </div>
    </div>
    {% endif %}
    
    <div class="video-container">
        <img src="{{ url_for('video_feed', mode=mode, username=username) }}" width="640" height="480" class="border rounded">
    </div>
    
    <p class="mt-3">{{ "Please stay still while we capture your face..." if mode=="capture" else "Look into the camera to verify." }}</p>
    
    {% if mode == "capture" %}
    <script>
        let progressInterval;
        
        function updateProgress() {
            fetch('/progress')
                .then(response => response.json())
                .then(data => {
                    const progressBar = document.getElementById('progress-bar');
                    const progressText = document.getElementById('progress-text');
                    
                    if (data.status === 'capturing') {
                        const percentage = (data.current / data.total) * 100;
                        progressBar.style.width = percentage + '%';
                        progressBar.setAttribute('aria-valuenow', data.current);
                        progressBar.textContent = `${data.current}/${data.total}`;
                        progressText.textContent = `Capturing images: ${data.current}/${data.total}`;
                        progressText.className = 'status-text text-primary';
                    } else if (data.status === 'training') {
                        progressBar.style.width = '100%';
                        progressBar.textContent = 'Training model...';
                        progressText.textContent = 'Training face recognition model...';
                        progressText.className = 'status-text text-warning';
                    } else if (data.status === 'completed') {
                        progressBar.style.width = '100%';
                        progressBar.textContent = 'Completed!';
                        progressText.textContent = 'Training completed successfully!';
                        progressText.className = 'status-text text-success';
                        clearInterval(progressInterval);
                        
                        // Redirect after training is complete
                        setTimeout(function() {
                            window.location.href = "{{ url_for('process', mode=mode, username=username) }}";
                        }, 3000);
                    }
                })
                .catch(error => {
                    console.error('Error fetching progress:', error);
                });
        }
        
        // Start checking progress immediately and then every 500ms
        updateProgress();
        progressInterval = setInterval(updateProgress, 500);
        
        // Fallback timeout (increased to accommodate 300 images + training)
        setTimeout(function() {
            window.location.href = "{{ url_for('process', mode=mode, username=username) }}";
        }, 120000); // 2 minutes
    </script>
    {% else %}
    <script>
        // For verification mode, keep original timeout
        setTimeout(function() {
            window.location.href = "{{ url_for('process', mode=mode, username=username) }}";
        }, 15000);
    </script>
    {% endif %}
</body>
</html>
